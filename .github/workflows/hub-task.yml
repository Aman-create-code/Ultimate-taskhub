name: Universal Cloud Hub Task

on:
  workflow_dispatch:
    inputs:
      task_type:
        description: 'Operation ausw√§hlen'
        required: true
        type: string

jobs:
  process:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: üõ†Ô∏è Setup System
        uses: actions/checkout@v4

      - name: üì¶ Install Power-Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick webp p7zip-full ffmpeg pandoc ghostscript unrar poppler-utils libimage-exiftool-perl qpdf libreoffice optipng jpegoptim
          sudo sed -i 's/rights="none" pattern="PDF"/rights="read|write" pattern="PDF"/' /etc/ImageMagick-6/policy.xml

      - name: üöÄ Omni-Processing Engine
        run: |
          mkdir -p output
          TASK="${{ github.event.inputs.task_type }}"
          echo "Executing: $TASK"

          # ARCHIVE TOOLS
          if [[ "$TASK" == "zip_all" ]]; then 7z a -tzip output/archive.zip ./input/*; fi
          if [[ "$TASK" == "rar_to_zip" ]]; then unrar x input/*.rar temp/ && 7z a -tzip output/converted.zip ./temp/*; fi
          if [[ "$TASK" == "encrypt_zip" ]]; then 7z a -tzip -p"Cloud123" output/secure.zip ./input/*; fi
          
          # IMAGE TOOLS
          if [[ "$TASK" == "webp_80" ]]; then for f in input/*.{jpg,png,jpeg}; do cwebp -q 80 "$f" -o "output/${f##*/}.webp"; done; fi
          if [[ "$TASK" == "resize_50" ]]; then for f in input/*; do convert "$f" -resize 50% "output/small_${f##*/}"; done; fi
          if [[ "$TASK" == "bw_filter" ]]; then for f in input/*; do convert "$f" -colorspace Gray "output/bw_${f##*/}"; done; fi
          if [[ "$TASK" == "optimize_img" ]]; then optipng input/*.png -dir output/ || jpegoptim input/*.jpg -d output/; fi
          
          # VIDEO & AUDIO
          if [[ "$TASK" == "mp4_to_gif" ]]; then ffmpeg -i input/*.mp4 -vf "fps=10,scale=480:-1" output/animated.gif; fi
          if [[ "$TASK" == "extract_audio" ]]; then ffmpeg -i input/* -q:a 0 -map a output/audio.mp3; fi
          if [[ "$TASK" == "compress_video" ]]; then ffmpeg -i input/* -vcodec libx265 -crf 28 output/compressed.mp4; fi
          
          # DOCUMENT TOOLS
          if [[ "$TASK" == "pdf_to_docx" ]]; then pandoc input/*.pdf -o output/converted.docx; fi
          if [[ "$TASK" == "merge_pdf" ]]; then qpdf --empty --pages input/*.pdf -- output/combined.pdf; fi
          if [[ "$TASK" == "docx_to_pdf" ]]; then libreoffice --headless --convert-to pdf input/*.docx --outdir output/; fi
          if [[ "$TASK" == "clean_exif" ]]; then exiftool -all= -o output/clean_ ./input/*; fi

      - name: üì§ Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: task-${{ github.run_number }}
          name: Cloud Result #${{ github.run_number }}
          files: output/*
          body: "Task: ${{ github.event.inputs.task_type }} abgeschlossen."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üßπ Cleanup Input
        run: |
          rm -rf input/*
          git config --global user.name "Cloud Bot"
          git config --global user.email "bot@github.com"
          git add input/
          git commit -m "Cleanup input folder" || echo "Nothing to clean"
          git push
